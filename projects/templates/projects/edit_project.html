{% extends "base.html" %}
{% load project_tags %}

{% block content %}
<h2>Edytuj projekt</h2>

<!-- Globalne błędy formularza -->
{% if form.errors %}
    <div class="alert alert-danger">
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                <p>{{ error }}</p>
            {% endfor %}
        {% endfor %}
    </div>
{% endif %}

<form method="post">
    {% csrf_token %}
    <div class="mb-3">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% if form.title.errors %}
            <div class="text-danger">
                {% for error in form.title.errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
    </div>
    <div class="mb-3">
        {{ form.code.label_tag }}
        {{ form.code }}
        {% if form.code.errors %}
            <div class="text-danger">
                {% for error in form.code.errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
    </div>
    <div class="mb-3">
        {{ form.description.label_tag }}
        {{ form.description }}
        {% if form.description.errors %}
            <div class="text-danger">
                {% for error in form.description.errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <h4>Wymagane umiejętności</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Umiejętność</th>
                <th>Liczba specjalistów</th>
                <th>Wybór pracowników</th>
            </tr>
        </thead>
        <tbody>
            {% for skill in skills %}
            <tr>
                <td>{{ skill.name }}</td>
                <td>
                    <input
                        type="number"
                        value="{{ skill_requirements|get_item:skill.id|default_if_none:0 }}"
                        name="required_count_{{ skill.id }}"
                        min="0"
                        class="form-control"
                        placeholder="Liczba specjalistów"
                    >
                </td>
                <td>
                    <select name="assign_employee_{{ skill.id }}" multiple class="form-control">
                        {% if suggested_employees %}
                            {% for employee in suggested_employees %}
                                {% if employee.skill == skill.name %}
                                    <option value="{{ employee.employee_id }}" {% if employee.selected %}selected{% endif %}>
                                        {{ employee.first_name }} {{ employee.last_name }}
                                    </option>
                                {% endif %}
                            {% endfor %}
                            {% if not suggested_employees|has_skill:skill.name and skill_requirements|get_item:skill.id > 0 %}
                                <option disabled>brak</option>
                            {% endif %}
                        {% else %}
                            {% for employee in assigned_employees|get_item:skill.id %}
                                <option value="{{ employee.id }}" selected>
                                    {{ employee.first_name }} {{ employee.last_name }}
                                </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button type="submit" name="suggest_employees" class="btn btn-primary">Sugeruj pracowników</button>
    <button type="submit" class="btn btn-success">Zapisz projekt</button>
</form>


{% endblock %}
